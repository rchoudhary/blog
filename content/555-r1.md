+++
title = "Debugging a 555 Circuit"
date = 2019-12-24T20:48:00-06:00
image = "https://rchoudhary.github.io/images/555-R1/schematic.png"
summary = "While building a 555 astable timer circuit, I noticed that the value of a seemingly unrelated resistor was actually of crucial importance to the overall functionality. Using simple circuit analysis and simulation, I got to the bottom of why exactly this resistor matters: it controls the asymptotic behavior of a timing capacitor."
+++

# The Setup

I bought some 555 timers and figured I would make an LED blink. I chose a frequency of $2\text{ Hz}$ just because and a duty cycle of $50\%$ because to me that's most visually appealing. 

According to [this tutorial](https://www.electronics-tutorials.ws/waveforms/555_oscillator.html), all I needed to do was build this circuit:

![555 50% duty cycle oscillator circuit](/images/555-R1/555-circuit_padded.png#c)

<div class="figure-caption">Reference: <a href="https://www.electronics-tutorials.ws/waveforms/555_oscillator.html">Electronics Tutorials</a></div>

&nbsp;

To get any particular frequency $f$, I simply needed to utilize the formula 

$$ f=\frac{1}{0.693(2R_2)C_1}\,\text{ Hz} $$

Using my impeccable algebra skills, I figured out that to get a $2 \text{ Hz}$ wave I needed

$$ R_2C_1 \approx 0.360$$

I looked through my electronics parts to see what values capacitors and resistors I had:

![available resistor values](/images/555-R1/res_values_padded.png#c)
![available capacitor values](/images/555-R1/cap_values.png#c)
<div class="figure-caption">Can you spot the manufacturer's typo in the capacitor values?</div>

Just from eyeballing it, a $330\text{ nF}$ capacitor and a $1\text{ MΩ}$ resistor would do the trick. In fact, if we plug in those values, we get $f \approx 2.186\text{ Hz}$. Good enough!

For $C\_2$, I didn't have a $0.01\text{ µF}$ capacitor, but I did have a $0.1\text{ µF}$ capacitor. $C_2$ is just there to stabilize the voltage on the `CONTROL` pin, so also good enough!

The question now was what to do about $R\_1$. How big or small should it be? The tutorial doesn't say much:

> Note that resistor R1 needs to be sufficiently high enough to ensure it does not interfere with the charging of the capacitor to produce the required 50% duty cycle

Is $100\text{ kΩ}$ "sufficiently high enough?" It seemed pretty big to me, and I mean that's what the picture used anyways. I went ahead built the circuit to test it out:

![555 astable circuit using 100 kilo ohms for R1](/images/555-R1/555_100k.jpg#c)

I powered it up, but whenever I turned the circuit on, the LED would flash briefly and then never turn on again. This would happen every time I connected the circuit to power:

![demonstration of 555 astable circuit using 100 kilo ohms for R1](/images/555-R1/555_100k_animation.gif#c)
<div class="figure-caption">I suppose I could create a $2\text{ Hz}$ wave by just plugging and unplugging the power manually</div>

I double- and triple-checked the wiring, but couldn't find anything wrong! I figured just mindlessly quadruple-checking was gonna be useless. I needed to Get Smart™️

# Background Reading

I'm gonna offload the work of explaining how the astable configuration of a 555 works to this person's video. The relevant part starts at 6:54 (maybe watch at 1.5x speed).

<div style="width: 100%;">
	<div style="width: 75%; margin-left:auto; margin-right:auto">
		<div class="video-wrapper" style="text-align: center;">
			<iframe src="https://www.youtube.com/embed/i0SNb__dkYI?rel=0&amp;start=414" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
		</div>
	</div>
</div>

# Debugging the Circuit

Unfortunately, I didn't have an oscilloscope lying around (on account of them being expensive), so I settled for simulation using [LTSpice](http://www.analog.com/en/design-center/design-tools-and-calculators/ltspice-simulator.html) (which is free). 

In LTSpice I created the schematic for my circuit:

![schematic of 555 astable circuit using 100 kilo ohms for R1](/images/555-R1/schematic.png#c)

I then simulated it and got the following results. The blue line is the voltage at the `OUT` pin and the green line is the voltage across the capacitor, i.e. the voltage at the `THRESHOLD` pin.

![simulation of 555 astable circuit using 100 kilo ohms for R1](/images/555-R1/graph_100k.png#c)
<div class="figure-caption">The `OUT` pin goes high for just a bit then turns off, never to turn on again</div>

After close inspection, I was curious as to why the capacitor topped out at $4.5\text{ V}$. After all, it's connected to the $5\text{ V}$ supply, so it should asymptotically approach $5\text{ V}$ right?

The trick was to think of the circuit like this:

![circuit redrawn to put focus on C1](/images/555-R1/C1_circuit.png#c)
<div class="figure-caption">I like to hand draw my circuit diagrams 'cause I think it adds a certain charm</div>

If there's one thing my undergrad degree taught me, it's recognizing **voltage dividers**, and boy howdy, $R\_1$ and $R\_2$ sure look like one! From there it was fairly straightforward to see what the issue was:

<span class="num-circle">1</span>$C\_1$ starts out discharged and so the `THRESHOLD` pin is low. This causes `OUT` to start out high.

<span class="num-circle">2</span>$C\_1$ charges up through both resistors.

![C1 charging up through R1 and R2](/images/555-R1/C1_charging_padded.png#c)

<span class="num-circle">3</span>$C\_1$ evenutally brings `THRESHOLD` up to ${2}/{3}\ V_{CC}$, and so the `OUT` pin goes low.

<span class="num-circle">4</span>`OUT` now acts as a ground, so $R\_1$ and $R\_2$ form a voltage divider. Since $C\_1$ is connected to the output of the voltage divider, it will charge up to the value of the divider. 

![R1 and R2 forming a voltage divider that determines what voltage C1 charges to](/images/555-R1/C1_volt_div_padded.png#c)

We can easily calculate what the steady-state voltage of $C\_1$ will be:
$$ \left(\frac{R_2}{R_1+R_2}\right) V\_{CC} = \left(\frac{10^6Ω}{10^3Ω+10^6Ω}\right)\left(5\text{ V}\right)\approx 4.545 \text{ V} $$
That explains why $C\_1$ stabilizes at roughly $4.5\text{ V}$

<span class="num-circle">5</span>Now nothing will change. In order for the `OUT` pin to toggle, the `THRESHOLD` pin needs to reach ${1}/{3}\ V_{CC}$. Unfortunately, the voltage divider keeps $C\_1$ at $4.5\text{ V}$.

# A First Attempt at a Fix

Ok, so we just need to pick a value of $R\_1$ such that $C\_1$ stabilizes at a voltage below ${1}/{3}\ V_{CC}$. Mathematically, this means we need

$$ \left(\frac{R_2}{R_1+R_2}\right) V\_{CC} < \frac{1}{3}\ V\_{CC} $$

A little bit of algebra gives us our constraint: <span class="highlight">in order for the circuit to oscillate, we need $R\_1>2\,R\_2 $</span>

Since in our circuit $R\_2=1\text{ MΩ}$, a nice choice for $R\_1$ would be $3\text{ MΩ}$. I used this new value of $R_1$ in my circuit and tested it out:

![demonstration of 555 astable circuit using 3 mega ohms for R1](/images/555-R1/555_3M_animation.gif#c)
<div class="figure-caption">The duty cycle doesn't seem quite right\...</div>

Eh\... I mean it's a $2\text{-ish Hz}$ wave (I checked by timing it with a stopwatch), but the pulsing doesn't look symmetric\... 

To confirm my suspicion, I simulated the circuit with $R\_1=3\text{ MΩ}$ and got the following graph:

![simulation of 555 astable circuit using 3 mega ohms for R1](/images/555-R1/graph_3m.png#c)
<div class="figure-caption">Simulation shows the capacitor waveform (green) is asymmetric</div>

Well, that most certainly is **not** a 50% duty cycle! It seems that $C\_1$ spends more time discharging than it does charging\...

# Why Is Charging Quicker Than Discharging?

Let's look at just the charging phase for a second. We'll call the voltage that the capacitor is trying to charge up to the **target voltage**.

By the laws of physics, a capacitor charges up to the target voltage **asymptotically**. So not only will the capacitor voltage never quite reach the target voltage, but it will actually charge **slower** the closer it gets.

Let's consider a hypothetical setup where two capacitors, labeled $\text{A}$ and $\text{B}$, will be **independently** charging up from $0\text{ V}$. Suppose capacitor $\text{A}$ is trying to charge up to $1.001\text{ V}$ and capacitor $\text{B}$ is trying to charge up to $10^{6}\text{ V}$. 

Which capacitor will reach $1\text{ V}$ **first**?

Well, as capacitor $\text{A}$'s voltage starts approaching $1\text{ V}$, it's basically approaching its target voltage of $1.001\text{ V}$, so its charging will start to slow down rapidly. However, as capacitor $\text{B}$'s voltage starts approaching $1\text{ V}$, it's still super far away from its target voltage of $10^{6}\text{ V}$, so its charging barely slows down.

So **capacitor $\text{B}$** will reach $1\text{ V}$ first! 

What we've just reasoned out is that <span class="highlight">the capacitor with the bigger gap between the target voltage and the cutoff voltage will charge the fastest.</span>

--- 

**Note:** A capacitor _discharges_ asymptotically as well, so these principles apply to a discharging capacitor just the same. That is, as a discharging capacitor's voltage approaches the target voltage, it starts to discharge slower. 

Furthermore, if we designed a similar experiment as previously described but with two discharging capacitors, we would also find that the capacitor with the bigger gap between the target voltage and the cutoff voltage will discharge the fastest.

---

Let's crunch some numbers to get a sense of how our circuit fares.

First up, **how big is the gap between the charging target voltage and the high cutoff voltage?** The high cutoff voltage is ${2}/{3}\ V\_{CC}$, and the capacitor is trying to charge up to $V\_{CC}$. So the gap is ${1}/{3}\ V\_{CC}\approx$<span class="highlight">$1.67\text{ V}$</span>

Up next, **how big is the gap between the discharging target voltage and the low cutoff voltage?** The low cutoff voltage is ${1}/{3}\ V\_{CC}$. The voltage the capacitor is trying to discharge down to is given by  

$$ \left(\frac{R_2}{R_1+R_2}\right) V\_{CC} = \left(\frac{1\text{ MΩ}}{3\text{ MΩ}+1\text{ MΩ}}\right) V\_{CC} = \frac{1}{4}\,V\_{CC} $$

Thus, the gap is ${1}/{12}\ V\_{CC}\approx$<span class="highlight">$0.42\text{ V}$</span>

Since the gap between charging target voltage and the high cutoff voltage is **bigger** than the gap between the discharging target voltage and the low cutoff voltage, charging is **faster**.

As a visual aid, let's look at a graph showing the charging and discharging phases of $C_1$. Real quick though, **let's change the discharging target voltage to $1.5\text{ V}$**, which will decrease the gap between the discharging target voltage and the low cutoff voltage down to just $0.17\text{ V}$. **This is just to make the effect of different sized gaps more visually apparent**. It's worth pointing out that this situation corresponds to us using $R\_1=2.33\text{ MΩ}$. This still satisfies the condition that $R\_1>2\,R\_2$, and so the circuit would still oscillate.

Anyways, here's the various parts of the graph:

  * The **x-axis** represents **time** and the **y-axis** represents **voltage**
  * The **blue curve** is the voltage of $C\_1$ during the **charging** phase
  * The **red curve** is the voltage of $C\_1$ during the **discharging** phase
  * The **black lines** are the charging and discharging **cutoff voltages** and are at ${2}/{3}\ V\_{CC}$ and ${1}/{3}\ V\_{CC}$ respectively
  * The **purple dotted lines** are the charging and discharging **target voltages** and are at $V\_{CC}=5\text{ V}$ and $1.5\text{ V}$ (remember we changed this) respectively
  * **Both phases start at $t=0$**
  * The **green X's** show when the **capacitors hit their cutoffs**, i.e. when the phases end

![graph showing the asymmetry between the charging and discharging phases](/images/555-R1/capacitor_graph.png#c)
<div class="figure-caption">The discharge phase takes longer than the charging phase because the low cutoff voltage is closer to the discharging target voltage</div>

It should now be easy to see that as the red curve approaches the low cutoff voltage, it's approaching the low target voltage as well, making it flatten out and slow down. The blue curve, however, seems to plow right through the high cutoff voltage, hardly slowing down.


# The Fix

The obvious solution is to move the discharge target voltage to be as close to $0\text{ V}$ as we can. That way the gap between the low cutoff voltage and the discharge target voltage will _also_ be ${1}/{3}\ V\_{CC}$.

The discharge target voltage is given by the voltage divider mentioned just a bit ago. To make the formula go to $0\text{ V}$, we can have $R_1$ go to $\infty\text{ Ω}$. 

Of course, $\infty\text{ Ω}$ is not a resistor value that I have in my box, but the gist is that <span class="highlight">we need to make $R_1$ _really, really_ big</span>.

Here's a GIF showing how increasing the value of $R_1$ makes the waveform look more like what we want.

![animation showing how increasing the value of R1 improves the waveform](/images/555-R1/converge.gif#c)
<div class="figure-caption">Simulating various values of $R_1$</div>

One thing that should really pop out from the GIF is that $R_1$ doesn't just affect the duty cycle of the wave, **it affects the frequency too**. So having a large $R_1$ is _doubly_ important to meeting the specifications.

Looks like having $R\_1 = 50\text{ MΩ}$ would give us a good-looking wave.

# Another Fix

One small problem: I don't have a $50\text{ MΩ}$ resistor sitting in my kit\...

Fortunately, there is something else we can do!

Recall (yet again) that the discharging target voltage for the capacitor, which we'll now call $V\_{low}$, is determined by the formula:

$$ V\_{low} = \left(\frac{R_2}{R_1+R_2}\right) V\_{CC} $$

We need $V\_{low} \approx 0\text{ V}$, and we originally thought to do that by taking $R_1$ to be a really large value.

But we can use a bit of algebra to instead write it like this:

$$ V\_{low} = \left(\frac{1}{1+\frac{R_1}{R_2}}\right) V\_{CC} $$

If we want $V\_{low}\rightarrow 0\text{ V}$, we need to make ${R\_1}/{R\_2}\rightarrow\infty$. To that end, we can either make $R\_1\rightarrow\infty\text{ Ω}$ as we did earlier, or we can instead make $R\_2\rightarrow 0\text{ Ω}$

So <span class="highlight">rather than _increasing_ $R_1$, we can instead _decrease_ $R_2$!</span>

Of course, remember that $R_2$ and $C_1$ together control the timing of the oscillator with the formula

$$ f=\frac{1}{0.693(2R_2)C_1}\,\text{ Hz} $$

From that formula we can clearly see that to keep $f$ the same, we just need to keep $R_2C_1$ the same. So if we _decrease_ $R_2$ by some factor, we just need to _increase_ $C_1$ by that _same_ factor.

# The Final Circuit

Let's put that to the test.

Here is an updated circuit where the value of $R_2$ has been _reduced_ by a factor of $10$, the value of $C_1$ has been _increased_ by a factor of $10$, and the value of $R_1$ has been _kept_ at $3\text{ MΩ}$:

![schematic of an ideal 555 50% duty cycle oscillator circuit](/images/555-R1/schematic_ideal.png#c)
<div class="figure-caption">A more ideal circuit, built using more convenient values of $R_1$ and $R_2$. The changed values are boxed in red</div>

Here is the corresponding simulation run:

![simulation of an ideal 555 50% duty cycle oscillator circuit](/images/555-R1/graph_ideal.png#c)
<div class="figure-caption">The "perfect" waveform created using more convenient values of $R_1$ and $R_2$</div>

&nbsp;

Now _that's_ what I'm talking about!

# Conclusion

The Electronics Tutorial article gave this advice for choosing $R_1$:

> Note that resistor R1 needs to be sufficiently high enough to ensure it does not interfere with the charging of the capacitor to produce the required 50% duty cycle 

Now we know what "sufficiently high enough" means:

<span class="num-circle">1</span> First and foremost, we need $R\_1 > 2\,R\_2$ so that the 555 circuit actually oscillates. 

<span class="num-circle">2</span> To actually get the $50\%$ duty cycle (and whatever frequency we configured the 555 to produce), we need $R\_1$ to be _much_ bigger than $R\_2$. We saw in the last section that a factor of $30$ seems to work. 

As a rule of thumb, it helps to use a relatively small value of $R\_2$ so that you don't need a humongous $R\_1$.
